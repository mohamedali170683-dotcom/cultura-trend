generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Team membership
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id])
  ownedTeams Team[]  @relation("TeamOwner")

  brands       Brand[]
  keywords     Keyword[]
  sessions     Session[]
  alertSettings AlertSettings?
  exports      Export[]

  @@index([teamId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Team {
  id        String   @id @default(cuid())
  name      String
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner   User   @relation("TeamOwner", fields: [ownerId], references: [id])
  members User[]

  @@index([ownerId])
}

model Brand {
  id        String   @id @default(cuid())
  userId    String
  name      String
  color     String   @default("#3b82f6")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  keywords Keyword[]

  @@index([userId])
}

model Keyword {
  id        String   @id @default(cuid())
  userId    String
  brandId   String
  keyword   String
  category  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand    Brand           @relation(fields: [brandId], references: [id], onDelete: Cascade)
  analyses TrendAnalysis[]
  history  TrendHistory[]

  @@index([userId])
  @@index([brandId])
}

model TrendAnalysis {
  id         String   @id @default(cuid())
  keywordId  String
  phase      String
  priority   String
  r0         Float
  snr        Float
  velocity   Float
  peakDays   Int
  confidence Float
  analyzedAt DateTime @default(now())

  // Data sources used
  newsScore     Float?
  redditScore   Float?
  googleScore   Float?
  socialScore   Float?

  keyword Keyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  @@index([keywordId])
  @@index([analyzedAt])
}

model TrendHistory {
  id        String   @id @default(cuid())
  keywordId String
  date      DateTime @default(now())

  // Metrics snapshot
  r0        Float
  snr       Float
  velocity  Float
  phase     String
  priority  String

  // Data source values
  newsVolume   Int?
  redditVolume Int?
  googleVolume Int?
  socialVolume Int?

  keyword Keyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  @@index([keywordId])
  @@index([date])
}

model AlertSettings {
  id        String   @id @default(cuid())
  userId    String   @unique

  // Email settings
  emailEnabled     Boolean @default(true)
  emailAddress     String?

  // Alert thresholds
  criticalAlerts   Boolean @default(true)
  highAlerts       Boolean @default(true)
  mediumAlerts     Boolean @default(false)
  lowAlerts        Boolean @default(false)

  // Frequency
  digestFrequency  String  @default("daily") // instant, daily, weekly

  // Slack integration
  slackEnabled     Boolean @default(false)
  slackWebhook     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Export {
  id        String   @id @default(cuid())
  userId    String
  type      String   // csv, pdf, json
  status    String   @default("pending") // pending, processing, completed, failed
  fileName  String?
  fileUrl   String?
  filters   String?  // JSON string of applied filters
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model DataSourceCache {
  id        String   @id @default(cuid())
  source    String   // news, reddit, google
  keyword   String
  data      String   // JSON data
  fetchedAt DateTime @default(now())
  expiresAt DateTime

  @@unique([source, keyword])
  @@index([expiresAt])
}
